<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Log Meal - UOPO</title>
<link rel="stylesheet" href="css/uopo-branding.css">
<style>
body, html { height: 100%; margin: 0; padding: 0; }
#camera-container {
  position:fixed; top:0; left:0; width:100vw; height:100vh; background:#1a140a; z-index:1001; display:none; flex-direction:column;align-items:center;justify-content:center;
}
#camera-video {
  width: 100vw; height: auto; max-height: 80vh; border-radius: 0;
  background: #232323; object-fit:cover;
}
#controls-overlay {
  position: absolute; top: 10px; width: 100vw; display: flex; justify-content: space-between; align-items:center; z-index:2; padding: 0 17px;
}
#bottom-controls {
  position: absolute; bottom: 35px; width: 100vw; text-align: center; z-index:2;
}
#capture-btn, #fallback-btn {
  font-size: 18px; font-weight: 700; background: #D4A574; color: white; border: none; border-radius: 9px; padding: 15px 35px; margin: 12px;
  box-shadow:0 5px 20px #B69D76; cursor:pointer;
  transition: filter 0.18s;
}
#capture-btn:hover, #fallback-btn:hover { filter:brightness(0.88);}
#close-cam { background:none; border:none; color:#fff; font-size:23px; font-weight:900; }
#photo-canvas { display:none; }
#photo-preview img { max-width:92vw; width: 220px; border-radius:14px; margin:10px auto 14px auto; box-shadow: 0 4px 14px #e1d1b6; display:block;}
.card, .page-header { display:none; } /* Only show core camera functionality */
</style>
</head>
<body>
<div id="camera-container">
  <video id="camera-video" autoplay playsinline></video>
  <div id="controls-overlay">
    <button id="close-cam" onclick="stopCamera()">âœ•</button>
    <span class="logo" style="color:#D4A574;font-size:23px;">ðŸŒ¾ UOPO</span>
  </div>
  <div id="bottom-controls">
    <button id="capture-btn" onclick="capturePhoto()">ðŸ“¸ Capture</button>
    <button id="fallback-btn" onclick="stopCamera();document.getElementById('upload-photo').click()">Manual Upload</button>
  </div>
</div>
<input type="file" id="upload-photo" accept="image/*" style="display:none;" onchange="loadFallbackPhoto(this)">
<div id="photo-preview"></div>
<script>
let videoStream = null;
function startCamera() {
  document.getElementById('camera-container').style.display = "flex";
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{
      videoStream = stream;
      const vid = document.getElementById('camera-video');
      vid.srcObject = stream;
      vid.play();
    });
}
function capturePhoto() {
  const video = document.getElementById('camera-video');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 400;
  canvas.height = video.videoHeight || 300;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg');
  stopCamera();
  document.body.style.background="#FEF8F0"; // restore bg
  document.getElementById('photo-preview').innerHTML = `<img src="${dataUrl}">`;
  sessionStorage.setItem('mealPhoto', dataUrl);
  setTimeout(()=>window.location.href="scan-result.html",900);
}
function stopCamera() {
  document.getElementById('camera-container').style.display = "none";
  if(videoStream) videoStream.getTracks().forEach(track=>track.stop());
}
function loadFallbackPhoto(input) {
  if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
          document.getElementById('photo-preview').innerHTML = `<img src="${e.target.result}" alt="Your photo">`;
          sessionStorage.setItem('mealPhoto', e.target.result);
          setTimeout(() => window.location.href = "scan-result.html", 1000);
      }
      reader.readAsDataURL(input.files[0]);
  }
}
window.onload = () => { startCamera(); }
</script>
</body>
</html>
